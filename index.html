<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Pro Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; -webkit-tap-highlight-color: transparent; color: #1A1A1A; }
        .nav-active { color: #7C3AED; }
        .page { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .status-confirmed { border-left: 5px solid #10B981; }
        .status-waiting { border-left: 5px solid #F59E0B; }
        .status-cancelled { border-left: 5px solid #EF4444; opacity: 0.5; }
    </style>
</head>
<body class="pb-32">

    <div id="loader" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600"></div>
    </div>

    <div id="page-home" class="page p-5">
        <h1 class="text-2xl font-black mb-6">–ì–ª–∞–≤–Ω–∞—è</h1>
        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-[2.5rem] p-7 text-white shadow-xl mb-8">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-indigo-100 text-[10px] font-bold uppercase tracking-wider mb-1">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å —Å–µ–≥–æ–¥–Ω—è</p>
                    <h2 id="today-profit" class="text-4xl font-black">0 ‚ÇΩ</h2>
                </div>
                <button onclick="findFreeSlots()" class="bg-white/20 p-2.5 rounded-2xl backdrop-blur-md text-[10px] font-bold uppercase">–û–∫–Ω–∞</button>
            </div>
            <p id="today-rev-sub" class="text-xs text-indigo-100 opacity-90">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        <h3 class="font-bold text-gray-800 mb-4 ml-1 flex items-center gap-2"><i class="far fa-calendar-check text-purple-500"></i> –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="home-upcoming" class="space-y-3"></div>
    </div>

    <div id="page-calendar" class="page p-5 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black">–ì—Ä–∞—Ñ–∏–∫</h1>
            <button onclick="findFreeSlots()" class="text-purple-600 text-[10px] font-bold bg-purple-50 px-4 py-2 rounded-xl border border-purple-100">–ü–û–ò–°–ö –û–ö–û–ù</button>
        </div>
        <div id="vertical-timeline" class="space-y-8"></div>
    </div>

    <div id="page-clients" class="page p-5 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-gray-900">–ë–∞–∑–∞</h1>
            <button onclick="openClientModal()" class="w-12 h-12 bg-gray-900 text-white rounded-2xl flex items-center justify-center shadow-lg"><i class="fas fa-plus"></i></button>
        </div>
        <div class="relative mb-6">
            <i class="fas fa-search absolute left-4 top-4 text-gray-300 text-sm"></i>
            <input type="text" id="client-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." class="w-full bg-white p-4 pl-12 rounded-2xl shadow-sm border border-gray-100 outline-none text-sm">
        </div>
        <div id="clients-list" class="space-y-3"></div>
    </div>

    <div id="page-stats" class="page p-5 hidden">
        <h1 class="text-2xl font-black mb-6">–û—Ç—á–µ—Ç—ã</h1>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-50">
                <p class="text-gray-400 text-[9px] font-bold uppercase mb-1 tracking-widest">–ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥</p>
                <p id="stat-net-profit" class="text-xl font-black text-green-600">0 ‚ÇΩ</p>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-50">
                <p class="text-gray-400 text-[9px] font-bold uppercase mb-1 tracking-widest">–ú–∞—Ä–∂–∞</p>
                <p id="stat-margin" class="text-xl font-black text-purple-600">0%</p>
            </div>
        </div>
        <div class="bg-white p-7 rounded-[2.5rem] shadow-sm">
            <h4 class="font-bold text-sm mb-5 text-gray-800 uppercase tracking-tighter">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —É—Å–ª—É–≥–∏</h4>
            <div id="top-services" class="space-y-4 text-sm font-bold"></div>
        </div>
    </div>

    <div id="modal-appt" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('modal-appt')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-7 max-h-[92vh] overflow-y-auto">
            <div id="appt-reminders" class="flex gap-2 mb-6 hidden">
                <button onclick="sendRemind('viber')" class="flex-1 bg-purple-600 text-white py-4 rounded-2xl font-bold text-[10px] flex items-center justify-center gap-2 uppercase"><i class="fab fa-viber text-sm"></i> Viber</button>
                <button onclick="sendRemind('wa')" class="flex-1 bg-green-500 text-white py-4 rounded-2xl font-bold text-[10px] flex items-center justify-center gap-2 uppercase"><i class="fab fa-whatsapp text-sm"></i> WhatsApp</button>
            </div>
            <form id="form-appt" class="space-y-4">
                <select id="appt-status" class="w-full bg-gray-100 p-4 rounded-2xl font-bold text-sm outline-none">
                    <option value="confirmed">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
                    <option value="waiting">‚è≥ –û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
                <select id="appt-client" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold text-sm"></select>
                <select id="appt-service" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold text-sm"></select>
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-[9px] font-bold text-gray-400 uppercase ml-2">–¶–µ–Ω–∞</label>
                        <input type="number" id="appt-price" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold">
                    </div>
                    <div class="w-1/2">
                        <label class="text-[9px] font-bold text-gray-400 uppercase ml-2">–†–∞—Å—Ö–æ–¥ (‚ÇΩ)</label>
                        <input type="number" id="appt-costs" value="0" class="w-full bg-gray-50 p-4 rounded-2xl font-bold text-red-500">
                    </div>
                </div>
                <div class="flex gap-3">
                    <input type="date" id="appt-date" required class="w-1/2 bg-gray-50 p-4 rounded-2xl font-bold text-sm">
                    <input type="time" id="appt-time" required class="w-1/2 bg-gray-50 p-4 rounded-2xl font-bold text-sm">
                </div>
                <div id="appt-edit-actions" class="hidden text-center pt-2">
                    <button type="button" onclick="handleStatus('deleteAppointment')" class="text-red-500 font-black text-xs uppercase tracking-widest">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>
                <div class="h-10"></div>
            </form>
        </div>
    </div>

    <div id="modal-client" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('modal-client')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-7">
            <h2 class="text-xl font-black mb-6 text-center text-gray-800">–ö–ª–∏–µ–Ω—Ç</h2>
            <form id="form-client" class="space-y-4">
                <input type="text" id="c-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                <input type="tel" id="c-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                <input type="text" id="c-inst" placeholder="Instagram / –°–æ—Ü—Å–µ—Ç—å" class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                <textarea id="c-notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ..." class="w-full bg-gray-50 p-4 rounded-2xl font-medium outline-none h-28"></textarea>
                <div class="h-10"></div>
            </form>
        </div>
    </div>

    <div id="modal-details" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="closeDetails()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-8 max-h-[88vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div id="det-name" class="text-2xl font-black text-gray-900 leading-tight"></div>
                <button onclick="editCurrentClient()" class="text-purple-600 font-bold text-[10px] bg-purple-50 px-4 py-2 rounded-xl uppercase">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div id="det-notes" class="bg-amber-50 p-5 rounded-3xl text-xs text-amber-800 font-medium mb-6 border border-amber-100 hidden"></div>
            <div class="flex gap-4 mb-8">
                <button id="det-viber" class="flex-1 bg-purple-600 text-white p-5 rounded-3xl text-center shadow-lg"><i class="fab fa-viber text-xl"></i></button>
                <button id="det-wa" class="flex-1 bg-green-500 text-white p-5 rounded-3xl text-center shadow-lg"><i class="fab fa-whatsapp text-xl"></i></button>
                <button id="det-call" class="flex-1 bg-gray-900 text-white p-5 rounded-3xl text-center shadow-lg"><i class="fas fa-phone-alt text-lg"></i></button>
            </div>
            <div id="det-history" class="space-y-3 pb-6"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-100 flex justify-around py-4 pb-10 z-40">
        <button onclick="switchTab('page-home')" class="nav-btn nav-active flex flex-col items-center gap-1 w-1/4" data-target="page-home">
            <i class="fas fa-home text-xl"></i><span class="text-[9px] font-bold uppercase">–û–±–∑–æ—Ä</span>
        </button>
        <button onclick="switchTab('page-calendar')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-1/4" data-target="page-calendar">
            <i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] font-bold uppercase">–ì—Ä–∞—Ñ–∏–∫</span>
        </button>
        <button onclick="switchTab('page-clients')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-1/4" data-target="page-clients">
            <i class="fas fa-user-friends text-xl"></i><span class="text-[9px] font-bold uppercase">–ë–∞–∑–∞</span>
        </button>
        <button onclick="switchTab('page-stats')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-1/4" data-target="page-stats">
            <i class="fas fa-chart-bar text-xl"></i><span class="text-[9px] font-bold uppercase">–û—Ç—á–µ—Ç—ã</span>
        </button>
    </nav>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz6wgmBYevBLhjjNKN7HJy3KF7_9vhuuwax6VxnK1ZgVUazEEkvnbV_-BFaBU5W83ETmg/exec";
        const tg = window.Telegram.WebApp;
        let store = { clients: [], appointments: [], services: [] };
        let currentEditId = null;
        let currentClientEditId = null;

        document.addEventListener('DOMContentLoaded', () => { loadData(); tg.expand(); setupPhoneInput(); });

        function setupPhoneInput() {
            const phoneInput = document.getElementById('c-phone');
            phoneInput.addEventListener('focus', () => { if (!phoneInput.value.startsWith('+375')) phoneInput.value = '+375'; });
            phoneInput.addEventListener('input', () => { if (!phoneInput.value.startsWith('+375')) phoneInput.value = '+375' + phoneInput.value.replace(/\D/g, '').replace(/^375/, ''); });
        }

        async function loadData() {
            try {
                const res = await fetch(`${API_URL}?action=getData`);
                store = await res.json();
                document.getElementById('loader').classList.add('hidden');
                refreshUI();
            } catch (e) { console.error(e); }
        }

        async function sendData(action, payload) {
            tg.MainButton.showProgress();
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
            await loadData();
            tg.MainButton.hideProgress();
        }

        function refreshUI() {
            renderDashboard();
            renderCalendar();
            renderClients();
            renderStats();
            populateSelects();
        }

        function findFreeSlots() {
            const today = new Date().toISOString().split('T')[0];
            const busy = store.appointments.filter(a => a.date.includes(today) && a.status !== 'cancelled').map(a => a.time);
            const allSlots = ["09:00", "11:00", "13:00", "15:00", "17:00", "19:00", "21:00"];
            const free = allSlots.filter(s => !busy.includes(s));
            tg.showPopup({ title: '–°–≤–æ–±–æ–¥–Ω–æ', message: free.length ? free.join(' | ') : '–û–∫–æ–Ω –Ω–µ—Ç', buttons: [{type: 'close'}] });
        }

        function renderCalendar() {
            const cont = document.getElementById('vertical-timeline');
            cont.innerHTML = '';
            const today = new Date();
            for (let i = 0; i < 14; i++) {
                const d = new Date(); d.setDate(today.getDate() + i);
                const ds = d.toISOString().split('T')[0];
                const dayAppts = store.appointments.filter(a => a.date.includes(ds)).sort((a,b) => a.time.localeCompare(b.time));
                cont.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center mb-4 px-1">
                            <span class="font-bold text-gray-400 text-[10px] uppercase tracking-widest">${d.toLocaleDateString('ru',{weekday:'short', day:'numeric', month:'short'})}</span>
                            <button onclick="fastAddAppt('${ds}')" class="text-purple-600 text-[10px] font-black uppercase">+ –ó–ê–ü–ò–°–¨</button>
                        </div>
                        <div class="space-y-3">
                            ${dayAppts.map(a => `
                                <div onclick="openEditAppt('${a.id}')" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-50 flex justify-between items-center status-${a.status}">
                                    <div>
                                        <p class="text-[10px] font-black ${a.status=='cancelled'?'text-gray-300':'text-purple-600'}">${a.time}</p>
                                        <p class="font-bold text-sm text-gray-800">${a.client_name}</p>
                                        <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">${a.service}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-sm text-gray-900">${a.price} ‚ÇΩ</p>
                                        <p class="text-[8px] text-red-400 font-bold">-${a.costs || 0} ‚ÇΩ</p>
                                    </div>
                                </div>
                            `).join('') || '<div class="p-6 border-2 border-dashed border-gray-100 rounded-[2rem] text-center text-[10px] text-gray-300 font-bold uppercase tracking-widest">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'}
                        </div>
                    </div>`;
            }
        }

        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayAppts = store.appointments.filter(a => a.date.includes(todayStr) && a.status !== 'cancelled');
            const rev = todayAppts.reduce((s,a) => s + Number(a.price), 0);
            const costs = todayAppts.reduce((s,a) => s + Number(a.costs || 0), 0);
            document.getElementById('today-profit').innerText = (rev - costs).toLocaleString() + ' ‚ÇΩ';
            document.getElementById('today-rev-sub').innerText = `–í—ã—Ä—É—á–∫–∞: ${rev} ‚ÇΩ | –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏: ${costs} ‚ÇΩ`;
            document.getElementById('home-upcoming').innerHTML = todayAppts.slice(0,4).map(a => `
                <div onclick="openEditAppt('${a.id}')" class="bg-white p-5 rounded-[1.5rem] shadow-sm flex justify-between items-center border border-gray-50">
                    <div class="flex items-center gap-4">
                        <div class="w-2 h-2 rounded-full ${a.status == 'confirmed' ? 'bg-green-500' : 'bg-amber-500'} shadow-sm"></div>
                        <span class="font-black text-purple-600 w-10 text-sm">${a.time}</span>
                        <span class="font-bold text-sm text-gray-800">${a.client_name}</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-200 text-xs"></i>
                </div>
            `).join('') || '<div class="text-center p-12 bg-white rounded-[2.5rem] text-gray-300 text-xs font-bold uppercase tracking-widest">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø—É—Å—Ç–æ</div>';
        }

        function renderClients() {
            const term = document.getElementById('client-search').value.toLowerCase();
            const cont = document.getElementById('clients-list');
            cont.innerHTML = store.clients.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term)).map(c => `
                <div onclick="showDetails('${c.id}')" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-50 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center font-black text-xl">${c.name[0]}</div>
                        <div><p class="font-black text-sm text-gray-900">${c.name}</p><p class="text-[10px] text-gray-400 font-bold">${c.phone}</p></div>
                    </div>
                    ${c.notes ? '<div class="bg-amber-100 text-amber-600 w-7 h-7 rounded-xl flex items-center justify-center text-xs"><i class="fas fa-sticky-note"></i></div>' : '<i class="fas fa-chevron-right text-gray-100"></i>'}
                </div>
            `).join('');
        }
        document.getElementById('client-search').oninput = renderClients;

        function showDetails(id) {
            const c = store.clients.find(c => c.id == id);
            currentClientEditId = id;
            document.getElementById('det-name').innerText = c.name;
            const cleanPhone = c.phone.replace(/\D/g, '');
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –í–ê–ô–ë–ï–† –ò –í–ê–¢–°–ê–ü –í –î–ï–¢–ê–õ–Ø–• –ß–ï–†–ï–ó tg.openLink
            document.getElementById('det-viber').onclick = () => tg.openLink(`viber://chat?number=${cleanPhone}`);
            document.getElementById('det-wa').onclick = () => tg.openLink(`https://wa.me/${cleanPhone}`);
            document.getElementById('det-call').onclick = () => tg.openLink(`tel:${c.phone}`);
            
            const notesEl = document.getElementById('det-notes');
            if(c.notes) { notesEl.innerText = "üìå –ó–ê–ú–ï–¢–ö–ê: " + c.notes; notesEl.classList.remove('hidden'); }
            else { notesEl.classList.add('hidden'); }

            const history = store.appointments.filter(a => a.client_id == id).sort((a,b) => b.date.localeCompare(a.date));
            document.getElementById('det-history').innerHTML = '<p class="text-[10px] font-black text-gray-300 uppercase tracking-widest mb-4">–ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤</p>' + history.map(a => `
                <div class="bg-gray-50 p-4 rounded-2xl flex justify-between items-center text-xs mb-2">
                    <div><p class="font-black text-gray-900">${new Date(a.date).toLocaleDateString('ru')}</p><p class="text-gray-400 font-bold uppercase text-[9px]">${a.service}</p></div>
                    <span class="text-green-600 font-black text-sm">${a.price} ‚ÇΩ</span>
                </div>
            `).join('');
            document.getElementById('modal-details').classList.remove('hidden');
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–ü–†–ê–í–ö–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô –ß–ï–†–ï–ó tg.openLink
        function sendRemind(type) {
            const a = store.appointments.find(i => i.id == currentEditId);
            const c = store.clients.find(i => i.id == a.client_id);
            const date = new Date(a.date).toLocaleDateString('ru', {day:'numeric', month:'long'});
            const text = `–ü—Ä–∏–≤–µ—Ç, ${c.name}! –ù–∞–ø–æ–º–∏–Ω–∞—é –æ –Ω–∞—à–µ–π –∑–∞–ø–∏—Å–∏: ${date} –≤ ${a.time}. –ñ–¥—É —Ç–µ–±—è!`;
            const phone = c.phone.replace(/\D/g, '');
            
            let url = (type === 'viber') 
                ? `viber://forward?text=${encodeURIComponent(text)}` 
                : `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            
            tg.openLink(url);
        }

        function renderStats() {
            const appts = store.appointments.filter(a => a.status !== 'cancelled');
            const rev = appts.reduce((s,a) => s + Number(a.price), 0);
            const costs = appts.reduce((s,a) => s + Number(a.costs || 0), 0);
            document.getElementById('stat-net-profit').innerText = (rev - costs).toLocaleString() + ' ‚ÇΩ';
            document.getElementById('stat-margin').innerText = rev ? Math.round(((rev-costs)/rev)*100) + '%' : '0%';
            
            const svcs = {};
            appts.forEach(a => svcs[a.service] = (svcs[a.service] || 0) + 1);
            document.getElementById('top-services').innerHTML = Object.entries(svcs).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n,c])=>`
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl mb-2"><span>${n}</span><span class="text-purple-600">${c}</span></div>
            `).join('');
        }

        function populateSelects() {
            const cS = document.getElementById('appt-client');
            const sS = document.getElementById('appt-service');
            cS.innerHTML = store.clients.map(c => `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`).join('');
            sS.innerHTML = store.services.map(s => `<option value="${s.name}" data-price="${s.price}">${s.name}</option>`).join('');
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            tg.MainButton.setText("–°–û–•–†–ê–ù–ò–¢–¨").show();
            tg.MainButton.offClick();
            tg.MainButton.onClick(() => {
                if (id === 'modal-appt') document.getElementById('form-appt').requestSubmit();
                if (id === 'modal-client') document.getElementById('form-client').requestSubmit();
            });
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); tg.MainButton.hide(); currentEditId = null; currentClientEditId = null; }
        
        function openEditAppt(id) {
            const a = store.appointments.find(i => i.id == id);
            currentEditId = id;
            document.getElementById('appt-status').value = a.status;
            document.getElementById('appt-client').value = a.client_id;
            document.getElementById('appt-service').value = a.service;
            document.getElementById('appt-price').value = a.price;
            document.getElementById('appt-costs').value = a.costs || 0;
            document.getElementById('appt-date').value = a.date.split('T')[0];
            document.getElementById('appt-time').value = a.time;
            document.getElementById('appt-edit-actions').classList.remove('hidden');
            document.getElementById('appt-reminders').classList.remove('hidden');
            openModal('modal-appt');
        }

        function openClientModal() { 
            if(!currentClientEditId) { document.getElementById('form-client').reset(); document.getElementById('c-phone').value = '+375'; } 
            openModal('modal-client'); 
        }
        
        function editCurrentClient() { closeDetails(); openClientModal(); }

        document.getElementById('form-appt').onsubmit = async (e) => {
            e.preventDefault();
            const c = document.getElementById('appt-client');
            const data = { id: currentEditId, status: document.getElementById('appt-status').value, client_id: c.value, client_name: c.options[c.selectedIndex].dataset.name, service: document.getElementById('appt-service').value, price: document.getElementById('appt-price').value, costs: document.getElementById('appt-costs').value, date: document.getElementById('appt-date').value, time: document.getElementById('appt-time').value };
            await sendData(currentEditId ? 'updateAppointment' : 'addAppointment', data);
            closeModal('modal-appt');
        };

        document.getElementById('form-client').onsubmit = async (e) => {
            e.preventDefault();
            const data = { id: currentClientEditId, name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value, instagram: document.getElementById('c-inst').value, notes: document.getElementById('c-notes').value };
            await sendData(currentClientEditId ? 'updateClient' : 'addClient', data);
            closeModal('modal-client');
        };

        function closeDetails() { document.getElementById('modal-details').classList.add('hidden'); }
        function fastAddAppt(ds) { document.getElementById('appt-date').value = ds; document.getElementById('appt-edit-actions').classList.add('hidden'); document.getElementById('appt-reminders').classList.add('hidden'); openModal('modal-appt'); }
        async function handleStatus(act) { if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) { await sendData(act, {id: currentEditId}); closeModal('modal-appt'); } }
        
        function switchTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('nav-active', 'text-gray-300'));
            document.querySelector(`[data-target="${id}"]`).classList.replace('text-gray-300', 'nav-active');
            tg.HapticFeedback.impactOccurred('light');
        }
    </script>
</body>
</html>
