<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; -webkit-tap-highlight-color: transparent; }
        .nav-active { color: #7C3AED; }
        .page { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .status-confirmed { border-left: 4px solid #10B981; }
        .status-waiting { border-left: 4px solid #F59E0B; }
        .status-cancelled { border-left: 4px solid #EF4444; opacity: 0.6; }
    </style>
</head>
<body class="pb-28">

    <div id="loader" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
    </div>

    <div id="page-home" class="page p-5">
        <h1 class="text-2xl font-extrabold mb-5">–û–±–∑–æ—Ä</h1>
        <div class="bg-gradient-to-br from-purple-600 to-indigo-700 rounded-[2rem] p-6 text-white shadow-xl mb-8 relative overflow-hidden">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-purple-100 text-[10px] font-bold uppercase mb-1">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å —Å–µ–≥–æ–¥–Ω—è</p>
                    <h2 id="today-profit" class="text-3xl font-black">0 ‚ÇΩ</h2>
                </div>
                <button onclick="findFreeSlots()" class="bg-white/20 p-2 rounded-xl backdrop-blur-md text-[10px] font-bold">–û–ö–ù–ê</button>
            </div>
            <p id="today-rev-sub" class="text-[10px] opacity-80">–í—ã—Ä—É—á–∫–∞: 0 ‚ÇΩ | –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏: 0 ‚ÇΩ</p>
        </div>
        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="far fa-clock text-purple-500"></i> –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="home-upcoming" class="space-y-3"></div>
    </div>

    <div id="page-calendar" class="page p-5 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-extrabold">–ì—Ä–∞—Ñ–∏–∫</h1>
            <button onclick="findFreeSlots()" class="text-purple-600 text-[10px] font-bold bg-purple-50 px-3 py-2 rounded-xl">–ù–ê–ô–¢–ò –û–ö–ù–û</button>
        </div>
        <div id="vertical-timeline" class="space-y-8"></div>
    </div>

    <div id="page-clients" class="page p-5 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-extrabold">–ë–∞–∑–∞</h1>
            <button onclick="openClientModal()" class="w-12 h-12 bg-gray-900 text-white rounded-2xl flex items-center justify-center shadow-lg"><i class="fas fa-plus"></i></button>
        </div>
        <input type="text" id="client-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." class="w-full bg-white p-4 rounded-2xl mb-6 shadow-sm border border-gray-100 outline-none">
        <div id="clients-list" class="space-y-3"></div>
    </div>

    <div id="page-stats" class="page p-5 hidden">
        <h1 class="text-2xl font-extrabold mb-6">–û—Ç—á–µ—Ç—ã</h1>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-50 text-center">
                <p class="text-gray-400 text-[9px] font-bold uppercase mb-1">–ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥</p>
                <p id="stat-net-profit" class="text-xl font-black text-green-600">0 ‚ÇΩ</p>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-50 text-center">
                <p class="text-gray-400 text-[9px] font-bold uppercase mb-1">–ú–∞—Ä–∂–∞</p>
                <p id="stat-margin" class="text-xl font-black text-purple-600">0%</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-[2rem] shadow-sm"><div id="top-services" class="space-y-4"></div></div>
    </div>

    <div id="modal-appt" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('modal-appt')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 max-h-[90vh] overflow-y-auto">
            <h2 id="appt-title" class="text-xl font-bold mb-6 text-center">–ó–∞–ø–∏—Å—å</h2>
            <form id="form-appt" class="space-y-4">
                <select id="appt-status" class="w-full bg-gray-100 p-4 rounded-2xl font-bold outline-none">
                    <option value="confirmed">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
                    <option value="waiting">‚è≥ –û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
                <select id="appt-client" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold"></select>
                <select id="appt-service" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold"></select>
                <div class="flex gap-3">
                    <input type="number" id="appt-price" placeholder="–¶–µ–Ω–∞" required class="w-1/2 bg-gray-50 p-4 rounded-2xl font-bold">
                    <input type="number" id="appt-costs" placeholder="–†–∞—Å—Ö–æ–¥ (0)" class="w-1/2 bg-gray-50 p-4 rounded-2xl font-bold text-red-500">
                </div>
                <div class="flex gap-3">
                    <input type="date" id="appt-date" required class="w-1/2 bg-gray-50 p-4 rounded-2xl font-bold">
                    <input type="time" id="appt-time" required class="w-1/2 bg-gray-50 p-4 rounded-2xl font-bold">
                </div>
                <div id="appt-edit-actions" class="hidden text-center"><button type="button" onclick="handleStatus('deleteAppointment')" class="text-red-500 font-bold p-4">–£–¥–∞–ª–∏—Ç—å</button></div>
            </form>
        </div>
    </div>

    <div id="modal-client" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('modal-client')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6">
            <h2 id="client-modal-title" class="text-xl font-bold mb-6 text-center">–ö–ª–∏–µ–Ω—Ç</h2>
            <form id="form-client" class="space-y-4">
                <input type="text" id="c-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                <input type="tel" id="c-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                <input type="text" id="c-inst" placeholder="Instagram" class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                <textarea id="c-notes" placeholder="–ó–∞–º–µ—Ç–∫–∏..." class="w-full bg-gray-50 p-4 rounded-2xl font-medium outline-none h-24"></textarea>
            </form>
        </div>
    </div>

    <div id="modal-details" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="closeDetails()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-8 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4"><div id="det-name" class="text-2xl font-black"></div><button onclick="editCurrentClient()" class="text-purple-600 font-bold text-xs bg-purple-50 px-4 py-2 rounded-xl">–ò–ó–ú–ï–ù–ò–¢–¨</button></div>
            <div id="det-notes" class="bg-amber-50 p-4 rounded-2xl text-xs text-amber-800 mb-6 hidden"></div>
            <div id="det-phone" class="text-gray-400 font-bold mb-6"></div>
            <div id="det-history" class="space-y-3 pb-6"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-100 flex justify-around py-4 pb-8 z-40">
        <button onclick="switchTab('page-home')" class="nav-btn nav-active flex flex-col items-center gap-1 w-1/4" data-target="page-home"><i class="fas fa-home text-xl"></i><span class="text-[9px] font-bold">–û–ë–ó–û–†</span></button>
        <button onclick="switchTab('page-calendar')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-1/4" data-target="page-calendar"><i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] font-bold">–ì–†–ê–§–ò–ö</span></button>
        <button onclick="switchTab('page-clients')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-1/4" data-target="page-clients"><i class="fas fa-users text-xl"></i><span class="text-[9px] font-bold">–ë–ê–ó–ê</span></button>
        <button onclick="switchTab('page-stats')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-1/4" data-target="page-stats"><i class="fas fa-chart-pie text-xl"></i><span class="text-[9px] font-bold">–û–¢–ß–ï–¢–´</span></button>
    </nav>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwIPDP2gEkpPEMeOu8uDGXrgXFDntf2qM9MaIu69QeIvWc41t4iLLALFYcx4xSbwoySEQ/exec";
        const tg = window.Telegram.WebApp;
        let store = { clients: [], appointments: [], services: [] };
        let currentEditId = null;
        let currentClientEditId = null;

        document.addEventListener('DOMContentLoaded', () => { loadData(); tg.expand(); setupPhoneInput(); });

        function setupPhoneInput() {
            const phoneInput = document.getElementById('c-phone');
            phoneInput.addEventListener('focus', () => { if (!phoneInput.value.startsWith('+375')) phoneInput.value = '+375'; });
            phoneInput.addEventListener('input', () => { if (!phoneInput.value.startsWith('+375')) phoneInput.value = '+375' + phoneInput.value.replace(/\D/g, '').replace(/^375/, ''); });
        }

        async function loadData() {
            try {
                const res = await fetch(`${API_URL}?action=getData`);
                store = await res.json();
                document.getElementById('loader').classList.add('hidden');
                refreshUI();
            } catch (e) { console.error(e); }
        }

        async function sendData(action, payload) {
            tg.MainButton.showProgress();
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
            await loadData();
            tg.MainButton.hideProgress();
            return await res.json();
        }

        function refreshUI() {
            renderDashboard();
            renderCalendar();
            renderClients();
            renderStats();
            populateSelects();
        }

        function findFreeSlots() {
            const today = new Date().toISOString().split('T')[0];
            const busy = store.appointments.filter(a => a.date.includes(today) && a.status !== 'cancelled').map(a => a.time);
            const allSlots = ["09:00", "11:00", "13:00", "15:00", "17:00", "19:00"];
            const free = allSlots.filter(s => !busy.includes(s));
            tg.showPopup({ title: '–û–∫–Ω–∞', message: free.length ? free.join(' | ') : '–û–∫–æ–Ω –Ω–µ—Ç', buttons: [{type: 'close'}] });
        }

        function renderCalendar() {
            const cont = document.getElementById('vertical-timeline');
            cont.innerHTML = '';
            const today = new Date();
            for (let i = 0; i < 14; i++) {
                const d = new Date(); d.setDate(today.getDate() + i);
                const ds = d.toISOString().split('T')[0];
                const dayAppts = store.appointments.filter(a => a.date.includes(ds)).sort((a,b) => a.time.localeCompare(b.time));
                cont.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center mb-4"><span class="font-bold text-gray-400 text-[10px] uppercase">${d.toLocaleDateString('ru',{weekday:'short', day:'numeric', month:'short'})}</span></div>
                        <div class="space-y-3">
                            ${dayAppts.map(a => `<div onclick="openEditAppt('${a.id}')" class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center status-${a.status}"><div><p class="text-[10px] font-black text-purple-600">${a.time}</p><p class="font-bold text-sm">${a.client_name}</p></div><div class="text-right"><p class="font-black text-sm">${a.price} ‚ÇΩ</p></div></div>`).join('') || '<p class="text-[10px] text-gray-300">–°–≤–æ–±–æ–¥–Ω–æ</p>'}
                        </div>
                    </div>`;
            }
        }

        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayAppts = store.appointments.filter(a => a.date.includes(todayStr) && a.status !== 'cancelled');
            const revenue = todayAppts.reduce((s,a) => s + Number(a.price), 0);
            const costs = todayAppts.reduce((s,a) => s + Number(a.costs || 0), 0);
            document.getElementById('today-profit').innerText = (revenue - costs).toLocaleString() + ' ‚ÇΩ';
            document.getElementById('today-rev-sub').innerText = `–í—ã—Ä—É—á–∫–∞: ${revenue} ‚ÇΩ | –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏: ${costs} ‚ÇΩ`;
            document.getElementById('home-upcoming').innerHTML = todayAppts.slice(0,3).map(a => `<div onclick="openEditAppt('${a.id}')" class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border-l-4 ${a.status == 'confirmed' ? 'border-green-500' : 'border-amber-500'}"><span class="font-black text-purple-600">${a.time}</span><span class="font-bold text-sm">${a.client_name}</span><i class="fas fa-chevron-right text-gray-200"></i></div>`).join('') || '<p class="text-center text-gray-300 text-sm py-4">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        }

        function renderClients() {
            const term = document.getElementById('client-search').value.toLowerCase();
            const cont = document.getElementById('clients-list');
            cont.innerHTML = store.clients.filter(c => c.name.toLowerCase().includes(term)).map(c => `<div onclick="showDetails('${c.id}')" class="bg-white p-4 rounded-2xl shadow-sm flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center font-bold">${c.name[0]}</div><div><p class="font-bold text-sm">${c.name}</p><p class="text-[10px] text-gray-400">${c.phone}</p></div></div><i class="fas fa-chevron-right text-gray-100"></i></div>`).join('');
        }

        function showDetails(id) {
            const c = store.clients.find(c => c.id == id);
            currentClientEditId = id;
            document.getElementById('det-name').innerText = c.name;
            document.getElementById('det-phone').innerText = c.phone;
            const notesEl = document.getElementById('det-notes');
            if(c.notes) { notesEl.innerText = "üìù " + c.notes; notesEl.classList.remove('hidden'); } else { notesEl.classList.add('hidden'); }
            const history = store.appointments.filter(a => a.client_id == id);
            document.getElementById('det-history').innerHTML = history.map(a => `<div class="bg-gray-50 p-3 rounded-xl flex justify-between text-xs mb-2"><span>${new Date(a.date).toLocaleDateString('ru')}</span><span class="font-bold">${a.price} ‚ÇΩ</span></div>`).join('');
            document.getElementById('modal-details').classList.remove('hidden');
        }

        function renderStats() {
            const appts = store.appointments.filter(a => a.status !== 'cancelled');
            const rev = appts.reduce((s,a) => s + Number(a.price), 0);
            const costs = appts.reduce((s,a) => s + Number(a.costs || 0), 0);
            document.getElementById('stat-net-profit').innerText = (rev - costs).toLocaleString() + ' ‚ÇΩ';
            document.getElementById('stat-margin').innerText = rev ? Math.round(((rev-costs)/rev)*100) + '%' : '0%';
        }

        function populateSelects() {
            const cS = document.getElementById('appt-client');
            const sS = document.getElementById('appt-service');
            cS.innerHTML = store.clients.map(c => `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`).join('');
            sS.innerHTML = store.services.map(s => `<option value="${s.name}" data-price="${s.price}">${s.name}</option>`).join('');
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            tg.MainButton.setText("–°–û–•–†–ê–ù–ò–¢–¨").show();
            tg.MainButton.offClick();
            tg.MainButton.onClick(() => {
                if (id === 'modal-appt') document.getElementById('form-appt').requestSubmit();
                if (id === 'modal-client') document.getElementById('form-client').requestSubmit();
            });
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); tg.MainButton.hide(); currentEditId = null; currentClientEditId = null; }
        function openEditAppt(id) {
            const a = store.appointments.find(i => i.id == id);
            currentEditId = id;
            document.getElementById('appt-status').value = a.status;
            document.getElementById('appt-client').value = a.client_id;
            document.getElementById('appt-service').value = a.service;
            document.getElementById('appt-price').value = a.price;
            document.getElementById('appt-costs').value = a.costs || 0;
            document.getElementById('appt-date').value = a.date.split('T')[0];
            document.getElementById('appt-time').value = a.time;
            document.getElementById('appt-edit-actions').classList.remove('hidden');
            openModal('modal-appt');
        }

        function openClientModal() { if(!currentClientEditId) { document.getElementById('form-client').reset(); document.getElementById('c-phone').value = '+375'; } openModal('modal-client'); }
        function editCurrentClient() { closeDetails(); openClientModal(); }

        document.getElementById('form-appt').onsubmit = async (e) => {
            e.preventDefault();
            const c = document.getElementById('appt-client');
            const data = { id: currentEditId, status: document.getElementById('appt-status').value, client_id: c.value, client_name: c.options[c.selectedIndex].dataset.name, service: document.getElementById('appt-service').value, price: document.getElementById('appt-price').value, costs: document.getElementById('appt-costs').value, date: document.getElementById('appt-date').value, time: document.getElementById('appt-time').value };
            await sendData(currentEditId ? 'updateAppointment' : 'addAppointment', data);
            closeModal('modal-appt');
        };

        document.getElementById('form-client').onsubmit = async (e) => {
            e.preventDefault();
            const data = { id: currentClientEditId, name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value, instagram: document.getElementById('c-inst').value, notes: document.getElementById('c-notes').value };
            await sendData(currentClientEditId ? 'updateClient' : 'addClient', data);
            closeModal('modal-client');
        };

        function closeDetails() { document.getElementById('modal-details').classList.add('hidden'); }
        function fastAddAppt(ds) { document.getElementById('appt-date').value = ds; openModal('modal-appt'); }
        async function handleStatus(act) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await sendData(act, {id: currentEditId}); closeModal('modal-appt'); } }
        function switchTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('nav-active', 'text-gray-300'));
            document.querySelector(`[data-target="${id}"]`).classList.replace('text-gray-300', 'nav-active');
            tg.HapticFeedback.impactOccurred('light');
        }
    </script>
</body>
</html>
